# see https://turbo.build/repo/docs/handbook/deploying-with-docker#the-lockfile-changes-too-often
FROM node:20.5.0-alpine3.18 as pruner
RUN npm install -g turbo@1
WORKDIR /usr/src/app
COPY . .
RUN turbo prune --scope=text-inference-batcher-nodejs --docker

# The second stage is the build stage. It installs the dependencies 
# uses the `out/json` directory and `-lock.json` files generated by the pruner
FROM node:20.5.0-alpine3.18 as builder
RUN npm install -g npm@9
RUN npm install -g turbo@1
WORKDIR /usr/src/app
COPY .gitignore .gitignore
COPY --from=pruner /usr/src/app/out/json/ .
COPY --from=pruner /usr/src/app/out/package-lock.json ./package-lock.json
RUN --mount=type=cache,target=/tmp/.npm \
    npm ci --no-audit --no-fund \
        --prefer-offline \
        --loglevel error --logs-max=0 \
        --cache /tmp/.npm

# And build the project
# `out/json` containes only changes of source code which are "scoped" to the project.
COPY --from=pruner /usr/src/app/out/full/ .
COPY turbo.json turbo.json
# `...` means Include dependencies of matched workspaces
# see https://turbo.build/repo/docs/core-concepts/monorepos/filtering#include-dependencies-of-matched-workspaces
RUN --mount=type=cache,target=/tmp/.turbo \
    npm run build -- --filter=text-inference-batcher-nodejs... --cache-dir=/tmp/.turbo

FROM node:20.5.0-alpine3.18 as production
WORKDIR /usr/src/app
COPY --from=pruner /usr/src/app/out/json/ .
COPY --from=pruner /usr/src/app/out/package-lock.json ./package-lock.json
COPY --from=builder /usr/src/app/apps/text-inference-batcher-nodejs apps/text-inference-batcher-nodejs
RUN npm install -g npm@9
RUN --mount=type=cache,target=/tmp/.npm \
    npm ci --no-audit --no-fund \
        --prefer-offline --omit=dev \
        --loglevel error --logs-max=0 \
        --cache /tmp/.npm
ENV NODE_ENV production
EXPOSE 8000
CMD ["node", "dist/index.js"]  
